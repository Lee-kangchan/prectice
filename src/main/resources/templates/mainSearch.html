<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">

<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <style>
        @media(max-width:767px) {
            .navbar .navbar-form {
                width: 185px;
                padding-left:0;
                padding-right:0;
            }
        }
        @media(min-width:768px) {
            .navbar .navbar-form {
                width: 250px;
            }
        }
        .navbar .navbar-form {
            padding-top: 0;
            padding-bottom: 0;
            margin-right: 0;
            margin-left: 0;
            border: 0;
            -webkit-box-shadow: none;
            box-shadow: none;
        }
        .mainTable{
            margin-top: 2%;
        }
        th, td{
            text-align: center;
        }
    </style>
</head>
<body class="container">
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <a class="navbar-brand" href="/main">future</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarText" aria-controls="navbarText" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarText">
        <ul class="navbar-nav mr-auto">

            <form class="form-inline my-2 my-lg-0" onsubmit="return false">
                <input class="form-control mr-sm-2" type="search" name="search" placeholder="Search" aria-label="Search">
                <button id="searchSubmit" class="btn btn-outline-success my-2 my-sm-0" onsubmit="return false">Search</button>
            </form>
            <script>
                $("#searchSubmit").click(function (){
                    var formData = {
                        'search' : $("input[name=email]").val()
                    }
                    console.log(formData.email)

                    $.ajax({
                        type : "POST",
                        url : "/v1/board/search?search="+formData.search,
                        data : formData,
                        dataType: 'json',
                        success : function(data){
                            alert(data.message)
                            location.href="/main/search?search="+formData.search
                        },
                        error : function (data){
                            alert(data.responseJSON.message)
                        }})

                })
            </script>
        </ul>

        <ul class="navbar-nav">
            <li th:if="${session.user == null}" class="nav-item"><a class="nav-link" href="/login">로그인</a></li>
            <li th:if="${session.user == null}" class="nav-item"><a class="nav-link" href="/sign">회원가입</a></li>
            <li th:if="${session.user != null}" class="nav-item"> <a class="nav-link" href="/myPage">회원변경</a> </li>
            <li th:if="${session.user != null}" class="nav-item"> <a class="nav-link" href="/logout">로그아웃</a> </li>
        </ul>
    </div>
</nav>
<div id="mainTable" class="mainTable">
    <table class="table table-hover">
        <thead>
        <tr>
            <th scope="col" colspan="1">번호</th>
            <th scope="col" colspan="5">제목</th>
            <th scope="col" colspan="2">날짜</th>
            <th scope="col" colspan="1">회원</th>
        </tr>
        </thead>
        <tbody id="tableContent">
        </tbody>
    </table>
    <nav aria-label="Page navigation example" id="page" style="display: flex;"></nav>

    <a th:if="${session.user != null}" href="/boardAdd"><button style="float: right;"type="submit" class="btn btn-primary">게시판 추가</button></a>
</div>
</body>
<script>
    function searchParam(key) {
        return new URLSearchParams(location.search).get(key);
    };
    var param = searchParam("page");
    var search = searchParam("search");
    let URL = "/main?";
    let search = "";
    let page = "page=";
    if(search != null) search ="search="+search+"&";
    if(param == null) param =1;
    $.ajax({
        type : "GET",
        url : "/v1/board?page="+param+"&search="+search,
        dataType: 'json',
        success : async function(data){
            console.log(data.toString())
            var tableHtml = "";
            await data.board.forEach(function(item, index){
                tableHtml +="    <tr>\n" +
                    "        <th scope=\"col\" colspan=\"1\">"+ item.boardSeq +"</td>\n" +
                    "        <td scope=\"col\" colspan=\"5\"><a style=\"color:black;text-decoration-line: none \"href='/mainDetail?board_seq=" +item.boardSeq+ "'>"+ item.boardTitle +"</a></td>\n" +
                    "        <td scope=\"col\" colspan=\"2\">"+ item.boardModifiedAt.split("T")[0] +"</td>\n" +
                    "        <td scope=\"col\" colspan=\"1\">"+item.boardUserEmail+"</td>\n" +
                    "    </tr>\n";
            });
            var startPage = Math.floor( data.page/50 ) *5;
            pagingHtml= "<ul class=\"pagination\" style=\"margin: auto;\">\n" +
                "            <li class=\"page-item\"><a id=\"previous\" class=\"page-link\" href=\"#\">Previous</a></li>\n"
            for(var i=startPage+1 ; i <= startPage+5; i++){
                if(i > data.length) break;
                pagingHtml += "<li class=\"page-item\"><a class=\"page-link\" href=\""+URL+search+page+i +"\">"+i +"</a></li>\n"
            }
            pagingHtml += " <li class=\"page-item\"><a id=\"next\" class=\"page-link\" href=\"#\">Next</a></li></ul>"


            $("#tableContent").html(tableHtml);
            $("#page").html(pagingHtml);



            $("#previous").click(function (){
                var pre = data.page/10 ;
                if(pre <= 0 ){
                    alert("뒤로 갈수 없습니다.")
                }else {
                    location.href = URL+search+page + pre;
                }
            })
            $("#next").click(function (){
                var next = data.page/10 + 2;
                if(next > data.length ){
                    alert("이후 게시물이 없습니다.")
                }else {
                    location.href = URL+search+page + next;
                }
            })


        },
        error : function (data){
            alert(data.responseJSON.message)
        }
    })

</script>
</html>
